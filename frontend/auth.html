<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="assets/css/auth.css?v=2025082301">
    <title>StudySync - Authentication</title>
    
    <style>
        .auth-note {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
            color: #495057;
        }
        
        .auth-note p {
            margin: 0 0 12px 0;
            font-weight: 500;
        }
        
        .auth-note ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .auth-note li {
            margin: 8px 0;
            color: #6c757d;
        }
        
        .auth-note strong {
            color: #495057;
        }
        
        /* Field state styles */
        .field-help {
            font-size: 12px;
            color: #6c757d;
            margin-top: 4px;
            display: block;
        }
        
        .form-group input[readonly] {
            background-color: #f8f9fa !important;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .form-group input.auto-filled {
            transition: all 0.3s ease;
        }
        
        .form-group input.auto-filled:not([readonly]) {
            cursor: text;
            opacity: 1;
        }
        
        /* Visual indicators for different field states */
        .form-group input.auto-filled {
            background-color: #e8f5e8 !important;
            border: 2px solid #28a745 !important;
        }
        
        .form-group input.manually-edited {
            background-color: #fff3cd !important;
            border: 2px solid #ffc107 !important;
        }
    </style>
    
    <!-- Google OAuth 2.0 - Load first -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <!-- Tesseract.js for real OCR processing -->
        <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
    
    <script>
        // Clear localStorage if requested
        if (window.location.search.includes('_clear=true')) {
            console.log('üßπ Clearing localStorage...');
            localStorage.clear();
            console.log('‚úÖ localStorage cleared');
        }
        
        // Debug: Show what's in localStorage
        console.log('üì¶ Current localStorage:', {
            access_token: localStorage.getItem('access_token'),
            user_data: localStorage.getItem('user_data'),
            refresh_token: localStorage.getItem('refresh_token')
        });
    </script>
    
    <!-- Configuration - Load after Google library -->
    <script>
        // Inline config to avoid loading issues
        const StudySyncConfig = {
            API_BASE_URL: 'http://127.0.0.1:8000',  // Django server
            GOOGLE_CLIENT_ID: '1061988044539-0vq3h3fk08tjs9ncg63oetudgvt0onu8.apps.googleusercontent.com',
            FRONTEND_URL: 'http://127.0.0.1:5500',  // Fixed Live Server port
            FEATURES: {
                GOOGLE_AUTH: true,
                FACEBOOK_AUTH: false,
                GITHUB_AUTH: false,
                EMAIL_VERIFICATION: true,
                PHONE_VERIFICATION: true
            }
        };
        window.StudySyncConfig = StudySyncConfig;
    </script>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">StudySync</a>
            <nav class="nav">
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <a href="index.html" class="nav-link">‚Üê Back to Home</a>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div class="auth-container">
                <!-- Progress Indicator -->
                <div class="progress-container" id="progressContainer" style="display: none;">
                    <div class="progress-steps">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <span>Account</span>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <span>Verification</span>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <span>Documents</span>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <span>Profile</span>
                        </div>
                    </div>
                </div>

                <!-- Step 1: Login or Initial Signup -->
                <div class="auth-card" id="step1">
                    <div class="auth-header">
                        <h2 id="authTitle">StudySync</h2>
                        <p id="authSubtitle">Loading...</p>
                    </div>

                    <!-- Google OAuth Sign-up Button -->
                    <div class="oauth-section">
                        <script>
                            // Set correct Google OAuth attributes based on URL parameters
                            const urlParams = new URLSearchParams(window.location.search);
                            const mode = urlParams.get('mode') || 'signup';
                            
                            document.addEventListener('DOMContentLoaded', function() {
                                const googleOnload = document.getElementById('g_id_onload');
                                const googleButton = document.getElementById('googleSignInButton');
                                
                                if (mode === 'login') {
                                    if (googleOnload) {
                                        googleOnload.setAttribute('data-context', 'signin');
                                    }
                                    if (googleButton) {
                                        googleButton.setAttribute('data-text', 'signin_with');
                                    }
                                } else {
                                    if (googleOnload) {
                                        googleOnload.setAttribute('data-context', 'signup');
                                    }
                                    if (googleButton) {
                                        googleButton.setAttribute('data-text', 'signup_with');
                                    }
                                }
                            });
                        </script>
                        
                        <div id="g_id_onload"
                             data-client_id="1061988044539-0vq3h3fk08tjs9ncg63oetudgvt0onu8.apps.googleusercontent.com"
                             data-context="signup"
                             data-ux_mode="popup"
                             data-callback="handleGoogleSignIn"
                             data-auto_prompt="false">
                        </div>
                        
                        <div class="g_id_signin" id="googleSignInButton"
                             data-type="standard"
                             data-shape="rectangular"
                             data-theme="outline"
                             data-text="signup_with"
                             data-size="large"
                             data-logo_alignment="left">
                        </div>
                    </div>

                    <div class="auth-note" id="authNote">
                        <p id="authNoteText">Loading...</p>
                        <ul id="authNoteList" style="display: none;">
                            <li><strong>Students:</strong> Upload your Student ID card</li>
                            <li><strong>Mentors:</strong> Upload your National ID and Organization ID</li>
                        </ul>
                    </div>

                    <!-- User type indicator (hidden by default) -->
                    <div class="user-type-indicator" id="userTypeIndicator" style="display: none;">
                        <div class="user-badge">
                            <span id="userTypeText"></span>
                            <span id="userTypeIcon"></span>
                        </div>
                    </div>

                    <div class="auth-footer">
                        <p id="authFooterText">Need help? <a href="/contact.html">Contact Support</a></p>
                    </div>
                </div>

                <!-- Step 2: Profile Completion -->
                <div class="auth-card" id="step2" style="display: none;">
                    <div class="auth-header">
                        <h2>Complete Your Profile</h2>
                        <p>Please fill in some additional information to complete your account</p>
                    </div>

                    <form class="auth-form" id="profileForm">
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <input type="text" id="firstName" name="firstName" placeholder="Enter your first name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <input type="text" id="lastName" name="lastName" placeholder="Enter your last name" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="phone">Phone Number</label>
                            <input type="tel" id="phone" name="phone" placeholder="Enter your phone number">
                        </div>
                        
                        <div class="form-group">
                            <label for="institution">Institution/University</label>
                            <input type="text" id="institution" name="institution" placeholder="Enter your school or university">
                        </div>
                        
                        <div class="form-group">
                            <label for="major">Field of Study/Major</label>
                            <input type="text" id="major" name="major" placeholder="e.g., Computer Science, Mathematics">
                        </div>
                        
                        <div class="form-group">
                            <label for="yearOfStudy">Year of Study</label>
                            <select id="yearOfStudy" name="yearOfStudy">
                                <option value="">Select year</option>
                                <option value="1">1st Year</option>
                                <option value="2">2nd Year</option>
                                <option value="3">3rd Year</option>
                                <option value="4">4th Year</option>
                                <option value="graduate">Graduate</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" id="profileSubmitBtn">Complete Registration</button>
                    </form>

                    <div class="auth-footer">
                        <button class="btn-link" id="backToStep1">‚Üê Back</button>
                    </div>
                </div>

                <!-- Step 3: Document Upload & Profile -->
                <div class="auth-card" id="step3" style="display: none;">
                    <div class="auth-header">
                        <h2 id="step3Title">Document Verification</h2>
                        <p id="step3Subtitle">Upload your ID for verification</p>
                    </div>

                    <form class="auth-form" id="documentForm">
                        <!-- Student ID Upload -->
                        <div class="upload-section" id="studentSection" style="display: none;">
                            <div class="upload-card" id="studentIdUpload">
                                <div class="upload-icon">üìÑ</div>
                                <h3>Student ID Card</h3>
                                <p>Upload a clear photo of your student ID</p>
                                <input type="file" id="studentIdFile" accept="image/*" class="file-input">
                                <button type="button" class="btn btn-outline" onclick="document.getElementById('studentIdFile').click()">
                                    Choose File
                                </button>
                                <div class="file-preview" id="studentIdPreview"></div>
                            </div>
                        </div>

                        <!-- Mentor Documents Upload -->
                        <div class="upload-section" id="mentorSection" style="display: none;">
                            <div class="upload-grid">
                                <div class="upload-card" id="nidUpload">
                                    <div class="upload-icon">üÜî</div>
                                    <h3>National ID</h3>
                                    <p>Upload your NID card</p>
                                    <input type="file" id="nid" accept="image/*" class="file-input">
                                    <button type="button" class="btn btn-outline" onclick="document.getElementById('nid').click()">
                                        Choose File
                                    </button>
                                    <div class="file-preview" id="nidPreview"></div>
                                </div>

                                <div class="upload-card" id="companyIdUpload">
                                    <div class="upload-icon">üè¢</div>
                                    <h3>Company ID</h3>
                                    <p>Upload your company ID card</p>
                                    <input type="file" id="companyId" accept="image/*" class="file-input">
                                    <button type="button" class="btn btn-outline" onclick="document.getElementById('companyId').click()">
                                        Choose File
                                    </button>
                                    <div class="file-preview" id="companyIdPreview"></div>
                                </div>
                            </div>

                            <!-- Professional Info for Mentors -->
                            <div class="professional-info">
                                <h3>Professional Information</h3>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="linkedin">LinkedIn Profile</label>
                                        <input type="url" id="linkedin" name="linkedin" placeholder="https://linkedin.com/in/username">
                                    </div>
                                    <div class="form-group">
                                        <label for="github">GitHub Profile</label>
                                        <input type="url" id="github" name="github" placeholder="https://github.com/username">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="experience">Years of Experience</label>
                                        <select id="experience" name="experience">
                                            <option value="">Select experience</option>
                                            <option value="1-2">1-2 years</option>
                                            <option value="3-5">3-5 years</option>
                                            <option value="5-10">5-10 years</option>
                                            <option value="10+">10+ years</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="expertise">Area of Expertise</label>
                                        <select id="expertise" name="expertise">
                                            <option value="">Select expertise</option>
                                            <option value="web-development">Web Development</option>
                                            <option value="mobile-development">Mobile Development</option>
                                            <option value="data-science">Data Science</option>
                                            <option value="machine-learning">Machine Learning</option>
                                            <option value="cybersecurity">Cybersecurity</option>
                                            <option value="ui-ux">UI/UX Design</option>
                                            <option value="devops">DevOps</option>
                                            <option value="blockchain">Blockchain</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Auto-filled Profile Information -->
                        <div class="profile-section">
                            <h3>Profile Information</h3>
                            <p class="info-text">Information extracted from your student ID card:</p>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="fullName">Full Name</label>
                                    <input type="text" id="fullName" name="fullName" readonly class="auto-filled" placeholder="Upload ID to extract name automatically">
                                    <small class="field-help">This will be filled automatically from your ID card</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="studentId">Student ID</label>
                                    <input type="text" id="studentId" name="studentId" readonly class="auto-filled" placeholder="Upload ID to extract student ID automatically">
                                    <small class="field-help">This will be filled automatically from your ID card</small>
                                </div>
                            </div>

                            <div class="info-note" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; border-left: 4px solid #007bff;">
                                <p style="margin: 0; color: #495057;"><strong>Note:</strong> Your ID card image will be saved for manual verification by our team.</p>
                            </div>

                            <div class="ocr-status" id="ocrStatus" style="display: none;">
                                <div class="status-indicator">
                                    <div class="spinner"></div>
                                    <span>Processing documents...</span>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" id="finalSubmitBtn">Next</button>
                    </form>

                    <div class="auth-footer">
                        <button class="btn-link" id="backToStep2">‚Üê Back</button>
                    </div>
                </div>

                <!-- Step 4: Additional Information -->
                <div class="auth-card" id="step4" style="display: none;">
                    <div class="auth-header">
                        <h2>Complete Your Profile</h2>
                        <p>Please provide some additional information to complete your registration</p>
                    </div>

                    <form class="auth-form" id="additionalInfoForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="organizationName">Organization/University Name</label>
                                <input type="text" id="organizationName" name="organizationName" placeholder="e.g., East West University" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="dateOfBirth">Date of Birth</label>
                                <input type="date" id="dateOfBirth" name="dateOfBirth" min="1960-01-01" max="2010-12-31" required>
                                <small class="field-help">Enter your birth date (year range: 1960-2010)</small>
                            </div>
                            <div class="form-group">
                                <label for="phoneNumber">Phone Number</label>
                                <input type="tel" id="phoneNumber" name="phoneNumber" placeholder="+880 1XXX-XXXXXX" required>
                            </div>
                        </div>

                        <div class="profile-summary" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0;">
                            <h3 style="margin-top: 0;">Profile Summary</h3>
                            <div class="summary-item">
                                <strong>Name:</strong> <span id="summaryName">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Email:</strong> <span id="summaryEmail">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Student ID:</strong> <span id="summaryStudentId">-</span>
                            </div>
                            <div class="summary-item">
                                <strong>Account Type:</strong> <span id="summaryUserType">-</span>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary btn-full" id="completeRegistrationBtn">Complete Registration</button>
                    </form>

                    <div class="auth-footer">
                        <button class="btn-link" id="backToStep3">‚Üê Back</button>
                    </div>
                </div>

                <!-- Success Page -->
                <div class="auth-card" id="successStep" style="display: none;">
                    <div class="success-animation">
                        <div class="checkmark">‚úì</div>
                    </div>
                    <div class="auth-header">
                        <h2>Welcome to StudySync!</h2>
                        <p id="successMessage">Your account has been created successfully.</p>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="location.href='profile.html'">Go to Profile</button>
                </div>
            </div>
        </div>
    </main>

    <!-- Load JavaScript files in proper order -->
    <script>
        // Global function to handle Google Sign-In response
        function handleGoogleSignIn(response) {
            console.log('üéØ Google Sign-In Response received:', response);
            
            if (response.credential) {
                try {
                    // Decode the JWT token to get user info
                    const payload = JSON.parse(atob(response.credential.split('.')[1]));
                    console.log('‚úÖ User info from Google:', payload);
                    
                    // Store user data globally
                    window.userData = {
                        email: payload.email,
                        name: payload.name,
                        googleId: payload.sub,
                        picture: payload.picture,
                        credential: response.credential,
                        firstName: payload.name.split(' ')[0] || '',
                        lastName: payload.name.split(' ').slice(1).join(' ') || ''
                    };
                    
                    console.log('ÔøΩ User data stored:', window.userData);
                    
                    // Get user type and mode
                    const userType = window.userType || 'student';
                    const authMode = window.authMode || 'signup';
                    window.userData.userType = userType;
                    
                    console.log('üîÑ Auth mode:', authMode);
                    
                    if (authMode === 'login') {
                        // For login: Try to authenticate existing user
                        authenticateExistingUser(window.userData);
                    } else {
                        // For signup: Proceed with registration flow
                        showMessage('Google account connected! Please upload your ID documents.', 'success');
                        goToDocumentUpload();
                    }
                    
                } catch (error) {
                    console.error('üí• Error processing Google response:', error);
                    showMessage('Error processing Google authentication: ' + error.message, 'error');
                }
            } else {
                console.error('‚ùå No credential received from Google');
                showMessage('Error: No credential received from Google', 'error');
            }
        }
        
        async function authenticateExistingUser(userData) {
            console.log('üîê Attempting to login existing user:', userData.email);
            
            try {
                // Call the login API endpoint (corrected URL)
                const response = await fetch('http://127.0.0.1:8000/api/auth/auth/google/login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        credential: userData.credential,
                        user_type: userData.userType
                    })
                });
                
                const result = await response.json();
                console.log('üîê Login response:', result);
                
                if (response.ok && result.access_token) {
                    // Login successful
                    console.log('‚úÖ Login successful!');
                    
                    // Store tokens and user data INCLUDING profile
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('refresh_token', result.refresh_token || '');
                    
                    // Combine user and profile data for consistent access
                    const combinedUserData = {
                        ...result.user,
                        profile: result.profile
                    };
                    localStorage.setItem('user_data', JSON.stringify(combinedUserData));
                    
                    showMessage('Login successful! Redirecting...', 'success');
                    
                    // Redirect to appropriate page
                    setTimeout(() => {
                        window.location.href = 'profile.html';
                    }, 1500);
                    
                } else {
                    // Login failed - user doesn't exist or other error
                    console.log('‚ùå Login failed:', result.message || 'User not found');
                    
                    if (result.message && result.message.includes('User not found')) {
                        showMessage('Account not found. Please sign up first or check your email.', 'error');
                        
                        // Offer to redirect to signup
                        setTimeout(() => {
                            if (confirm('Account not found. Would you like to create a new account instead?')) {
                                const currentUrl = new URL(window.location);
                                currentUrl.searchParams.set('mode', 'signup');
                                window.location.href = currentUrl.toString();
                            }
                        }, 2000);
                    } else {
                        showMessage('Login failed: ' + (result.message || 'Please try again'), 'error');
                    }
                }
                
            } catch (error) {
                console.error('üí• Login API error:', error);
                showMessage('Login failed. Please check your internet connection and try again.', 'error');
            }
        }
        
        function showMessage(message, type) {
            // Remove any existing messages
            const existingMessage = document.querySelector('.auth-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create new message
            const messageDiv = document.createElement('div');
            messageDiv.className = `auth-message ${type}`;
            messageDiv.style.cssText = `
                padding: 15px;
                margin: 15px 0;
                border-radius: 5px;
                font-weight: 500;
                ${type === 'success' ? 'background: #d4edda; color: #155724; border: 1px solid #c3e6cb;' : ''}
                ${type === 'error' ? 'background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;' : ''}
            `;
            messageDiv.textContent = message;
            
            // Insert after auth header
            const authHeader = document.querySelector('.auth-header');
            if (authHeader) {
                authHeader.parentNode.insertBefore(messageDiv, authHeader.nextSibling);
            }
        }
        
        function goToDocumentUpload() {
            // Hide step 1
            document.getElementById('step1').style.display = 'none';
            
            // Show step 3 (document upload)
            const step3 = document.getElementById('step3');
            if (step3) {
                step3.style.display = 'block';
                
                // Show appropriate upload section and set required fields
                if (window.userData.userType === 'student') {
                    document.getElementById('studentSection').style.display = 'block';
                    document.getElementById('mentorSection').style.display = 'none';
                    
                    // Remove required from mentor fields
                    document.getElementById('experience').removeAttribute('required');
                    document.getElementById('expertise').removeAttribute('required');
                } else {
                    document.getElementById('studentSection').style.display = 'none';
                    document.getElementById('mentorSection').style.display = 'block';
                    
                    // Add required to mentor fields
                    document.getElementById('experience').setAttribute('required', 'required');
                    document.getElementById('expertise').setAttribute('required', 'required');
                }
                
                // Setup file uploads
                setupFileUploads();
            }
        }
        
        function setupFileUploads() {
            const fileInputs = ['studentIdFile', 'nid', 'companyId'];
            
            fileInputs.forEach(inputId => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('change', function(e) {
                        handleFileUpload(e, inputId);
                    });
                }
            });
            
            // Setup form submission
            const documentForm = document.getElementById('documentForm');
            if (documentForm) {
                console.log('‚úÖ Document form found, setting up event listener');
                documentForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('üìù Document form submitted, calling goToAdditionalInfo()');
                    goToAdditionalInfo();
                });
            } else {
                console.error('‚ùå Document form not found!');
            }
            
            // Setup additional info form submission
            const additionalInfoForm = document.getElementById('additionalInfoForm');
            if (additionalInfoForm) {
                console.log('‚úÖ Additional info form found, setting up event listener');
                additionalInfoForm.addEventListener('submit', function(e) {
                    console.log('üìù Additional info form submitted!');
                    e.preventDefault();
                    processDocumentsAndCreateAccount();
                });
            } else {
                console.error('‚ùå Additional info form not found!');
            }
            
            // Setup profile form submission to prevent page refresh
            const profileForm = document.getElementById('profileForm');
            if (profileForm) {
                profileForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    console.log('Profile form submitted - preventing default refresh');
                    // This form is just for display, actual submission happens in additionalInfoForm
                });
            }
            
            // Setup back button for step 4
            const backToStep3 = document.getElementById('backToStep3');
            if (backToStep3) {
                backToStep3.addEventListener('click', function() {
                    document.getElementById('step4').style.display = 'none';
                    document.getElementById('step3').style.display = 'block';
                });
            }
        }
        
        function handleFileUpload(event, inputId) {
            const file = event.target.files[0];
            if (!file) return;

            // Clear previous data to avoid caching issues
            clearPreviousOCRData();

            // Validate file type and size
            const validTypes = ['image/jpeg', 'image/png', 'image/jpg'];
            const maxSize = 5 * 1024 * 1024; // 5MB

            if (!validTypes.includes(file.type)) {
                showMessage('Please upload a valid image file (JPEG, PNG)', 'error');
                return;
            }

            if (file.size > maxSize) {
                showMessage('File size must be less than 5MB', 'error');
                return;
            }

            const previewId = inputId + 'Preview';
            const preview = document.getElementById(previewId);
            
            if (preview) {
                preview.innerHTML = `‚úÖ ${file.name} (${(file.size / 1024 / 1024).toFixed(2)}MB)`;
                preview.style.display = 'block';
            }

            // Store file
            if (!window.userData.files) window.userData.files = {};
            window.userData.files[inputId] = file;
            
            console.log(`üìÅ New file uploaded: ${inputId} = ${file.name}`);
            
            // Start OCR processing immediately
            processOCR(file, inputId);
        }
        
        function clearPreviousOCRData() {
            // Clear and reset form fields to readonly state
            const fieldsToClean = ['fullName', 'studentId'];
            fieldsToClean.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    field.style.background = '';
                    field.style.border = '';
                    field.classList.remove('auto-filled');
                    
                    // Make field readonly again until new upload
                    field.setAttribute('readonly', 'readonly');
                    field.placeholder = fieldId === 'fullName' 
                        ? 'Upload ID to extract name automatically'
                        : 'Upload ID to extract student ID automatically';
                    
                    // Reset help text
                    const fieldGroup = field.closest('.form-group');
                    if (fieldGroup) {
                        let helpText = fieldGroup.querySelector('.field-help');
                        if (helpText) {
                            helpText.textContent = 'This will be filled automatically from your ID card';
                            helpText.style.color = '';
                        }
                    }
                }
            });
            
            // Clear stored OCR data
            if (window.userData.ocrData) {
                window.userData.ocrData = {};
            }
            
            // Hide any previous OCR status
            hideOCRStatus();
            
            console.log('üßπ Cleared previous OCR data and reset fields to readonly');
        }
        
        async function processOCR(file, documentType) {
            try {
                console.log('üîç Starting OCR processing for:', documentType);
                console.log('üìÅ File details:', file.name, file.size, file.type);
                
                // Show OCR processing indicator
                showOCRStatus('Analyzing image and extracting text... This may take a few moments for clear results.', 'processing');
                
                // Initialize OCR processor
                if (typeof OCRProcessor === 'undefined') {
                    throw new Error('OCR processor not available. Please refresh the page.');
                }
                
                const ocrProcessor = new OCRProcessor();
                
                // Process the document with enhanced extraction
                const extractedData = await ocrProcessor.processDocument(file, documentType);
                console.log('üìã OCR extraction completed:', extractedData);
                
                // Validate extracted data
                if (!extractedData.firstName && !extractedData.lastName && !extractedData.studentId) {
                    throw new Error('Could not extract name or student ID from the image. Please ensure the image is clear and try again.');
                }
                
                // Fill form fields with extracted data
                fillFormFields(extractedData, documentType);
                
                // Show success message
                showOCRStatus('‚úÖ Information extracted successfully! Please verify the details below.', 'success');
                
                // Store extracted data
                if (!window.userData.ocrData) window.userData.ocrData = {};
                window.userData.ocrData[documentType] = extractedData;
                
                // Hide OCR status after 5 seconds
                setTimeout(() => {
                    hideOCRStatus();
                }, 5000);
                
            } catch (error) {
                console.error('‚ùå OCR processing failed:', error);
                
                // Show error message with retry option
                showOCRStatus(`‚ùå ${error.message}`, 'error');
                
                // Clear the file input to allow re-upload
                let fileInputId = documentType;
                if (documentType === 'studentIdFile') {
                    fileInputId = 'studentIdFile';
                }
                const input = document.getElementById(fileInputId);
                if (input) {
                    input.value = '';
                }
                
                // Clear the preview
                const previewId = documentType + 'Preview';
                const preview = document.getElementById(previewId);
                if (preview) {
                    preview.style.display = 'none';
                }
                
                // Remove from stored files
                if (window.userData.files && window.userData.files[documentType]) {
                    delete window.userData.files[documentType];
                }
                
                // Clear form fields
                clearPreviousOCRData();
            }
        }
        
        function fillFormFields(extractedData, documentType) {
            console.log('üìù Filling form fields with extracted data:', extractedData);
            console.log('üìù Available keys in extractedData:', Object.keys(extractedData));
            
            // Fill Full Name Field
            let fullName = '';
            if (extractedData.fullName) {
                fullName = extractedData.fullName;
            } else if (extractedData.firstName && extractedData.lastName) {
                fullName = `${extractedData.firstName} ${extractedData.lastName}`.trim();
            } else if (extractedData.firstName) {
                fullName = extractedData.firstName;
            }
            
            if (fullName) {
                fillField('fullName', fullName);
                
                // Update stored user data (keep both formats for backend compatibility)
                window.userData.fullName = fullName;
                const nameParts = fullName.split(/\s+/);
                window.userData.firstName = nameParts[0] || '';
                window.userData.lastName = nameParts.slice(1).join(' ') || '';
                
                console.log(`‚úÖ Full Name filled: ${fullName}`);
            } else {
                console.warn('‚ö†Ô∏è Name not found in extracted data');
            }
            
            // Fill Student ID
            let studentIdValue = '';
            if (extractedData.studentId) {
                studentIdValue = extractedData.studentId;
            } else if (extractedData.idNumber) {
                studentIdValue = extractedData.idNumber;
            }
            
            if (studentIdValue) {
                fillField('studentId', studentIdValue);
                // Store in both formats for compatibility
                window.userData.studentId = studentIdValue;
                window.userData.idNumber = studentIdValue;
                console.log(`‚úÖ Student ID filled: ${studentIdValue}`);
            } else {
                console.warn('‚ö†Ô∏è Student ID not found in extracted data');
            }
            
            // Store the uploaded image for manual verification
            if (window.userData.files && window.userData.files[documentType]) {
                console.log('üíæ ID card image stored for manual verification');
            }
            
            console.log('‚úÖ Form filling completed');
        }
        
        function fillField(fieldId, value) {
            console.log(`üîç Attempting to fill field: ${fieldId} with value: "${value}"`);
            
            const field = document.getElementById(fieldId);
            
            if (!field) {
                console.error(`‚ùå Field with ID "${fieldId}" not found in DOM`);
                return;
            }
            
            if (!value || value.trim() === '') {
                console.warn(`‚ö†Ô∏è Empty value provided for field "${fieldId}"`);
                return;
            }
            
            try {
                // Remove readonly attribute to make field editable
                field.removeAttribute('readonly');
                
                // Set the value
                field.value = value.trim();
                
                // Add visual indication that field was auto-filled but is now editable
                field.classList.add('auto-filled');
                field.style.background = '#e8f5e8';
                field.style.border = '2px solid #28a745';
                
                // Update placeholder to show it's editable
                field.placeholder = 'You can edit this if needed';
                
                // Add edit instruction
                const fieldGroup = field.closest('.form-group');
                if (fieldGroup) {
                    let helpText = fieldGroup.querySelector('.field-help');
                    if (helpText) {
                        helpText.textContent = '‚úÖ Auto-filled from ID card - You can edit if needed';
                        helpText.style.color = '#28a745';
                    }
                }
                
                console.log(`‚úÖ Successfully filled and made editable ${fieldId}: ${value}`);
                
                // Add event listener to track manual edits
                field.addEventListener('input', function() {
                    // Change visual style when user manually edits
                    field.style.background = '#fff3cd';
                    field.style.border = '2px solid #ffc107';
                    
                    const helpText = fieldGroup?.querySelector('.field-help');
                    if (helpText) {
                        helpText.textContent = '‚úèÔ∏è Manually edited by user';
                        helpText.style.color = '#856404';
                    }
                }, { once: true }); // Only trigger once per field
                
            } catch (error) {
                console.error(`‚ùå Error filling field ${fieldId}:`, error);
            }
        }
        
        function showOCRStatus(message, type) {
            let statusDiv = document.getElementById('ocrStatus');
            
            if (!statusDiv) {
                // Create OCR status element
                statusDiv = document.createElement('div');
                statusDiv.id = 'ocrStatus';
                statusDiv.style.cssText = `
                    margin: 15px 0;
                    padding: 15px;
                    border-radius: 8px;
                    font-weight: 500;
                    text-align: center;
                `;
                
                // Insert before profile section
                const profileSection = document.querySelector('.profile-section');
                if (profileSection) {
                    profileSection.parentNode.insertBefore(statusDiv, profileSection);
                }
            }
            
            // Update status based on type
            if (type === 'processing') {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
                statusDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border: 2px solid #0c5460; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span>${message}</span>
                    </div>
                `;
            } else if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = `‚úÖ ${message}`;
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.innerHTML = `‚ùå ${message}`;
            }
            
            statusDiv.style.display = 'block';
            
            // Add CSS animation for spinner
            if (!document.getElementById('spinnerStyle')) {
                const style = document.createElement('style');
                style.id = 'spinnerStyle';
                style.textContent = `
                    @keyframes spin {
                        0% { transform: rotate(0deg); }
                        100% { transform: rotate(360deg); }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        function hideOCRStatus() {
            const statusDiv = document.getElementById('ocrStatus');
            if (statusDiv) {
                statusDiv.style.display = 'none';
            }
        }
        
        function goToAdditionalInfo() {
            console.log('üöÄ goToAdditionalInfo() called');
            
            // Validate that required fields are filled
            const fullName = document.getElementById('fullName').value.trim();
            const studentId = document.getElementById('studentId').value.trim();
            
            console.log('üìã Field values:', { fullName, studentId });
            
            if (!fullName || !studentId) {
                console.warn('‚ö†Ô∏è Validation failed - missing required fields');
                showMessage('Please upload your ID card and ensure the fields are filled correctly.', 'error');
                return;
            }
            
            console.log('‚úÖ Validation passed, transitioning to step 4');
            
            // Show step 4
            document.getElementById('step3').style.display = 'none';
            document.getElementById('step4').style.display = 'block';
            
            // Populate summary
            updateProfileSummary();
            
            console.log('‚úÖ Moved to additional info step');
        }
        
        function updateProfileSummary() {
            console.log('üìä Updating profile summary...');
            
            // Update the profile summary in step 4
            const summaryName = document.getElementById('summaryName');
            const summaryEmail = document.getElementById('summaryEmail');
            const summaryStudentId = document.getElementById('summaryStudentId');
            const summaryUserType = document.getElementById('summaryUserType');
            
            if (summaryName) {
                summaryName.textContent = document.getElementById('fullName').value || '-';
                console.log('‚úÖ Updated summary name');
            }
            if (summaryEmail) {
                summaryEmail.textContent = window.userData?.email || '-';
                console.log('‚úÖ Updated summary email');
            }
            if (summaryStudentId) {
                summaryStudentId.textContent = document.getElementById('studentId').value || '-';
                console.log('‚úÖ Updated summary student ID');
            }
            if (summaryUserType) {
                summaryUserType.textContent = (window.userData?.userType || 'student').charAt(0).toUpperCase() + 
                    (window.userData?.userType || 'student').slice(1);
                console.log('‚úÖ Updated summary user type');
            }
            
            console.log('üìä Profile summary update completed');
        }
        
        async function processDocumentsAndCreateAccount() {
            console.log('üöÄ processDocumentsAndCreateAccount called!');
            try {
                console.log('üöÄ Creating account...');
                showMessage('Processing documents and creating account...', 'success');
                
                // Disable submit button
                const submitBtn = document.getElementById('completeRegistrationBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Processing...';
                }
                
                // Collect additional information from step 4
                const organizationName = document.getElementById('organizationName').value.trim();
                const dateOfBirth = document.getElementById('dateOfBirth').value;
                const phoneNumber = document.getElementById('phoneNumber').value.trim();
                const fullName = document.getElementById('fullName').value.trim();
                const studentId = document.getElementById('studentId').value.trim();
                
                console.log('üìã Form data collected:', {
                    organizationName, dateOfBirth, phoneNumber, fullName, studentId
                });
                
                // Validate additional fields
                if (!organizationName || !dateOfBirth || !phoneNumber) {
                    console.error('‚ùå Validation failed - missing required fields');
                    throw new Error('Please fill in all required fields.');
                }
                
                console.log('‚úÖ Validation passed');
                
                // Create comprehensive account data
                const accountData = {
                    credential: window.userData.credential,
                    email: window.userData.email,
                    name: fullName || window.userData.name,
                    google_id: window.userData.googleId,
                    profile_picture: window.userData.picture,
                    user_type: window.userData.userType,
                    first_name: window.userData.firstName,
                    last_name: window.userData.lastName,
                    // Additional fields
                    student_id: studentId,
                    organization_name: organizationName,
                    date_of_birth: dateOfBirth,
                    phone_number: phoneNumber,
                    // OCR extracted data
                    extracted_full_name: fullName,
                    ocr_data: window.userData.ocrData || {}
                };
                
                console.log('ÔøΩ Sending account data:', accountData);
                
                // Send to backend
                const response = await fetch('http://127.0.0.1:8000/api/auth/auth/google/oauth/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(accountData)
                });
                
                const result = await response.json();
                console.log('üì• Backend response:', result);
                
                if (response.ok) {
                    // Store tokens and combined user data
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('refresh_token', result.refresh_token);
                    
                    // Combine user and profile data for consistent access
                    const combinedUserData = {
                        ...result.user,
                        profile: result.profile
                    };
                    localStorage.setItem('user_data', JSON.stringify(combinedUserData));
                    
                    showMessage('Account created successfully! Welcome to StudySync!', 'success');
                    
                    // Redirect to dashboard page
                    setTimeout(() => {
                        const dashboardUrl = 'dashboard.html';
                        console.log('üîÑ Redirecting to:', dashboardUrl);
                        window.location.href = dashboardUrl;
                    }, 2000);
                } else {
                    throw new Error(result.error || result.message || 'Account creation failed');
                }
                
            } catch (error) {
                console.error('‚ùå Account creation failed:', error);
                
                // Show user-friendly error message
                let errorMessage = 'Account creation failed. ';
                
                if (error.message.includes('fetch') || error.message.includes('Failed to fetch')) {
                    errorMessage += 'Please check if the Django server is running at http://127.0.0.1:8000/';
                } else {
                    errorMessage += error.message;
                }
                
                showMessage(errorMessage, 'error');
                
                // Re-enable submit button
                const submitBtn = document.getElementById('completeRegistrationBtn');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Complete Registration';
                }
            }
        }
        
        // Initialize page immediately when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Auth page DOM ready');
            
            // Update title based on user type and mode
            const urlParams = new URLSearchParams(window.location.search);
            const userType = urlParams.get('type') || 'student';
            const mode = urlParams.get('mode') || 'signup';
            
            console.log('üîç Auth mode:', mode, 'User type:', userType);
            
            const title = document.getElementById('authTitle');
            const subtitle = document.getElementById('authSubtitle');
            const googleOnload = document.getElementById('g_id_onload');
            const authNote = document.getElementById('authNoteText');
            const authNoteList = document.getElementById('authNoteList');
            
            // Update Google OAuth configuration BEFORE rendering
            if (googleOnload) {
                if (mode === 'login') {
                    googleOnload.setAttribute('data-context', 'signin');
                } else {
                    googleOnload.setAttribute('data-context', 'signup');
                }
            }
            
            // Update UI based on mode
            if (mode === 'login') {
                if (title) {
                    title.textContent = `Welcome Back!`;
                }
                if (subtitle) {
                    subtitle.textContent = `Sign in to your ${userType} account`;
                }
                if (authNote) {
                    authNote.textContent = 'Sign in with your Google account to access StudySync.';
                }
                if (authNoteList) {
                    authNoteList.style.display = 'none';
                }
                
                // Update Google button for login - recreate it
                recreateGoogleButton('signin_with');
                
            } else {
                // Signup mode (default)
                if (title) {
                    title.textContent = `Create Your ${userType === 'student' ? 'Student' : 'Mentor'} Account`;
                }
                if (subtitle) {
                    subtitle.textContent = `Join StudySync as a ${userType}`;
                }
                if (authNote) {
                    authNote.textContent = 'After signing up with Google, you\'ll be asked to upload your ID documents for verification.';
                }
                if (authNoteList) {
                    authNoteList.style.display = 'block';
                }
                
                // Update Google button for signup - recreate it
                recreateGoogleButton('signup_with');
            }
            
            // Store mode globally for use in handleGoogleSignIn
            window.authMode = mode;
            window.userType = userType;
        });
        
        function recreateGoogleButton(textType) {
            const oauthSection = document.querySelector('.oauth-section');
            const googleOnload = document.getElementById('g_id_onload');
            
            // Remove existing button
            const existingButton = document.querySelector('.g_id_signin');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Create new button with correct text
            const newButton = document.createElement('div');
            newButton.className = 'g_id_signin';
            newButton.setAttribute('data-type', 'standard');
            newButton.setAttribute('data-shape', 'rectangular');
            newButton.setAttribute('data-theme', 'outline');
            newButton.setAttribute('data-text', textType);
            newButton.setAttribute('data-size', 'large');
            newButton.setAttribute('data-logo_alignment', 'left');
            
            // Insert after the g_id_onload div
            googleOnload.parentNode.insertBefore(newButton, googleOnload.nextSibling);
            
            // Force Google to re-render
            if (window.google && window.google.accounts && window.google.accounts.id) {
                setTimeout(() => {
                    window.google.accounts.id.renderButton(newButton, {
                        type: 'standard',
                        shape: 'rectangular',
                        theme: 'outline',
                        text: textType,
                        size: 'large',
                        logo_alignment: 'left'
                    });
                }, 100);
            }
        }
    </script>
    
    <!-- OCR Processing Script -->
    <script src="assets/js/ocr.js"></script>
</body>
</html>
