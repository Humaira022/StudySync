<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="assets/css/main.css">
        <script src="assets/js/config.js"></script>
        <title>StudySync</title>
    </head>
    <body>
        <header class="header">
            <div class="container">
                <a href="index.html" class="logo">StudySync</a>
                <nav class="nav">
                    <a href="my-posts.html" class="nav-link">My Posts</a>
                    <a href="mentorship.html" class="nav-link">Mentorship</a>
                    <a href="about.html" class="nav-link">About</a>
                    <a href="contact.html" class="nav-link">Contact</a>
                    <!-- Show avatar if logged in, otherwise show login button -->
                    <div id="navAuthSection">
                        <a href="user-selection.html" class="btn btn-primary" id="loginBtn">Log in</a>
                        <div class="user-avatar-dropdown" id="userAvatarSection" style="display: none;">
                            <img id="navUserAvatar" src="https://via.placeholder.com/40/3b82f6/ffffff?text=U" alt="User Avatar" class="user-avatar" onclick="toggleDropdown()">
                            <div id="userDropdown" class="dropdown-content">
                                <a href="profile.html">üë§ Profile Settings</a>
                                <a href="#" onclick="logout()">üö™ Logout</a>
                            </div>
                        </div>
                    </div>
                </nav>
            </div>
        </header>

        <main class="main">
            <div class="container">
                <div class="content-wrapper">
                    <aside class="sidebar">
                        <div class="filters">
                            <div class="filter-group">
                                <label for="subject">Subject</label>
                                <select id="subject" class="select">
                                    <option>All</option>
                                    <option>JavaScript</option>
                                    <option>Math</option>
                                    <option>English</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label for="time">Time</label>
                                <select id="time" class="select">
                                    <option>All</option>
                                    <option>Morning</option>
                                    <option>Afternoon</option>
                                    <option>Evening</option>
                                </select>
                            </div>
                            <button class="btn btn-primary btn-full" onclick="openPostModal()">Post a Session</button>
                        </div>
                        
                        <!-- Premium Membership -->
                        <div class="premium-membership-section">
                            <h3 class="premium-section-title">üöÄ Upgrade to Premium</h3>
                            <div class="premium-benefits">
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">‚ú®</span>
                                    <span class="benefit-text">Ad-free experience</span>
                                </div>
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">üìö</span>
                                    <span class="benefit-text">Unlimited posts</span>
                                </div>
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">üë®‚Äçüè´</span>
                                    <span class="benefit-text">Access mentorship</span>
                                </div>
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">üìä</span>
                                    <span class="benefit-text">Advanced analytics</span>
                                </div>
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">üìé</span>
                                    <span class="benefit-text">File sharing</span>
                                </div>
                                <div class="premium-benefit-item">
                                    <span class="benefit-icon">üé®</span>
                                    <span class="benefit-text">Custom themes</span>
                                </div>
                            </div>
                            <div class="premium-pricing">
                                <div class="premium-price">‡ß≥300/month</div>
                                <div class="premium-price-note">Cancel anytime</div>
                            </div>
                        </div>
                    </aside>

                    <div class="main-content">
                        <section class="study-sessions">
                            <div class="section-header">
                                <h2 class="section-title">Find your study partner</h2>
                                <p class="section-subtitle">Students post when they want to study, along with their available time slots.</p>
                            </div>

                            <div class="session-list" id="sessionList">
                                <!-- Loading indicator -->
                                <div id="loadingIndicator" class="loading-indicator">
                                    <div class="loading-spinner"></div>
                                    <p>Loading study sessions...</p>
                                </div>
                                
                                <!-- Posts will be loaded dynamically here -->
                            </div>
                        </section>

                        <aside class="messages-panel">
                            <h3 class="messages-title">Messages</h3>
                            <div class="search-box">
                                <input type="text" placeholder="Search" class="search-input">
                            </div>
                            <div class="message-item">
                                <div class="user-avatar-large blue-avatar small">
                                    <span>J</span>
                                </div>

                                <div class="message-content">
                                    <h4 class="message-sender">Humaira</h4>
                                    <p class="message-text">Sure, see you tomorrow!</p>
                                </div>
                            </div>
                        </aside>
                    </div>
                </div>
            </div>
        </main>

    <!-- Post Creation Modal -->
    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create a Study Session</h2>
                <span class="close" onclick="closePostModal()">&times;</span>
            </div>
            <form id="postForm" class="post-form">
                <div class="form-group">
                    <label for="postTitle">Title *</label>
                    <input type="text" id="postTitle" name="title" required maxlength="255" 
                           placeholder="e.g., Looking for JavaScript study partner">
                </div>
                
                <div class="form-group">
                    <label for="postContent">Description *</label>
                    <textarea id="postContent" name="content" required rows="4" 
                              placeholder="Describe what you want to study, your goals, and any specific topics..."></textarea>
                </div>
                
                <div class="form-row">
                <div class="form-group">
                    <label for="postType">Type *</label>
                    <select id="postType" name="post_type" required>
                        <option value="">Select type</option>
                        <option value="study_group">Study Group</option>
                        <option value="help_request">Help Request</option>
                        <option value="discussion">Discussion</option>
                        <option value="mentorship">Mentorship (Premium only)</option>
                    </select>
                    <small class="form-help">Note: Mentorship posts require premium membership</small>
                </div>                    <div class="form-group">
                        <label for="subjectArea">Subject *</label>
                        <select id="subjectArea" name="subject_area" required>
                            <option value="">Select subject</option>
                            <option value="JavaScript">JavaScript</option>
                            <option value="Python">Python</option>
                            <option value="Java">Java</option>
                            <option value="C++">C++</option>
                            <option value="Math">Mathematics</option>
                            <option value="Physics">Physics</option>
                            <option value="Chemistry">Chemistry</option>
                            <option value="English">English</option>
                            <option value="History">History</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="difficultyLevel">Difficulty</label>
                        <select id="difficultyLevel" name="difficulty_level">
                            <option value="">Select difficulty</option>
                            <option value="beginner">Beginner</option>
                            <option value="intermediate">Intermediate</option>
                            <option value="advanced">Advanced</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="expiresAt">Expires (optional)</label>
                        <input type="datetime-local" id="expiresAt" name="expires_at">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="tags">Tags (optional)</label>
                    <input type="text" id="tags" name="tags" 
                           placeholder="Add tags separated by commas (e.g., beginner, online, weekend)">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePostModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Post</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Debug timing information
        console.log('Script loaded at:', new Date().toISOString());
        
        // Prevent multiple rapid reloads and initialization
        let isLoading = false;
        let lastLoadTime = 0;
        let isInitialized = false;

        // Load user data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMContentLoaded fired at:', new Date().toISOString());
            
            // Prevent multiple initializations
            if (isInitialized) {
                console.log('Page already initialized, skipping...');
                return;
            }

            // Prevent rapid successive loads
            const now = Date.now();
            if (now - lastLoadTime < 1000) {
                console.log('Too soon since last load, skipping...');
                return;
            }
            lastLoadTime = now;
            isInitialized = true;

            console.log('Initializing page...');
            checkLoginStatus();
            loadStudySessions();
            setupEventListeners();
        });

        function checkLoginStatus() {
            const accessToken = localStorage.getItem('access_token');
            const userData = localStorage.getItem('user_data');
            
            const loginBtn = document.getElementById('loginBtn');
            const userAvatarSection = document.getElementById('userAvatarSection');
            
            if (accessToken && userData) {
                // User is logged in - show avatar dropdown
                loginBtn.style.display = 'none';
                userAvatarSection.style.display = 'block';
                
                // Load avatar using EXACT same logic as profile page
                try {
                    const user = JSON.parse(userData);
                    updateNavbarAvatar(user, user.profile);
                } catch (e) {
                    console.error('Error parsing user data:', e);
                    updateNavbarAvatar({ first_name: 'User', last_name: '' }, null);
                }
            } else {
                // User is not logged in - show login button
                loginBtn.style.display = 'inline-block';
                userAvatarSection.style.display = 'none';
            }
        }

        // EXACT same avatar logic as working profile page
        function updateNavbarAvatar(user, profile = null) {
            const firstName = user?.first_name || '';
            const lastName = user?.last_name || '';
            
            // Update navbar avatar with smaller default (EXACT same as profile page)
            const navDefaultAvatar = 'https://via.placeholder.com/40/3b82f6/ffffff?text=' + 
                encodeURIComponent((firstName[0] || '') + (lastName[0] || ''));
            const navAvatarSrc = profile?.profile_picture || user?.profile_picture || navDefaultAvatar;
            
            const navAvatar = document.getElementById('navUserAvatar');
            if (navAvatar) {
                navAvatar.src = navAvatarSrc;
                console.log('‚úÖ Avatar loaded:', navAvatarSrc);
            }
        }

        function toggleDropdown() {
            document.getElementById("userDropdown").classList.toggle("show");
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.reload();
        }

        // ========================
        // EVENT LISTENERS SETUP
        // ========================
        
        let eventListenersAttached = false;
        
        function setupEventListeners() {
            // Prevent multiple attachments
            if (eventListenersAttached) {
                console.log('Event listeners already attached, skipping...');
                return;
            }
            
            console.log('Setting up event listeners...');
            
            // Post form submission
            const postForm = document.getElementById('postForm');
            if (postForm) {
                postForm.addEventListener('submit', handlePostSubmission);
            }

            // Modal close on outside click
            const modal = document.getElementById('postModal');
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closePostModal();
                    }
                });
            }

            // Escape key to close modal - only attach once
            document.addEventListener('keydown', handleEscapeKey);
            
            // Close dropdown when clicking outside - only attach once
            document.addEventListener('click', handleDropdownClose);
            
            eventListenersAttached = true;
        }

        // Separate handlers to avoid duplicates
        function handleEscapeKey(e) {
            const modal = document.getElementById('postModal');
            if (e.key === 'Escape' && modal && modal.style.display === 'block') {
                closePostModal();
            }
        }

        function handleDropdownClose(event) {
            const dropdown = document.getElementById('userDropdown');
            const avatar = document.getElementById('navUserAvatar');
            
            if (dropdown && !dropdown.contains(event.target) && (!avatar || !avatar.contains(event.target))) {
                dropdown.classList.remove('show');
            }
        }

        // ========================
        // POST CREATION FUNCTIONALITY
        // ========================

        function openPostModal() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showNotification('Please log in to create a post.', 'error');
                setTimeout(() => {
                    window.location.href = 'user-selection.html';
                }, 1500);
                return;
            }
            
            const modal = document.getElementById('postModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
                
                // Focus first input
                const firstInput = modal.querySelector('input, textarea, select');
                if (firstInput) {
                    setTimeout(() => firstInput.focus(), 100);
                }
            }
        }

        function closePostModal() {
            const modal = document.getElementById('postModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
                
                // Reset form
                const form = document.getElementById('postForm');
                if (form) {
                    form.reset();
                }
            }
        }

        // Handle post form submission with better error handling
        async function handlePostSubmission(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            
            try {
                // Show loading state
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creating...';
                
                const formData = new FormData(e.target);
                const postData = {
                    title: formData.get('title').trim(),
                    content: formData.get('content').trim(),
                    post_type: formData.get('post_type'),
                    subject_area: formData.get('subject_area'),
                    difficulty_level: formData.get('difficulty_level') || null,
                    expires_at: formData.get('expires_at') || null,
                    tags: formData.get('tags') ? 
                        formData.get('tags').split(',').map(tag => tag.trim()).filter(tag => tag) : []
                };

                // Validate required fields
                if (!postData.title || !postData.content || !postData.post_type || !postData.subject_area) {
                    throw new Error('Please fill in all required fields.');
                }

                const response = await fetch(`${window.StudySyncConfig.API_BASE_URL}/api/study-sessions/posts/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                    },
                    body: JSON.stringify(postData)
                });

                if (response.ok) {
                    const newPost = await response.json();
                    closePostModal();
                    showNotification('Post created successfully! üéâ', 'success');
                    loadStudySessions(); // Reload the feed
                } else {
                    const errorData = await response.json();
                    console.error('Server error:', errorData);
                    
                    if (response.status === 401) {
                        showNotification('Session expired. Please log in again.', 'error');
                        localStorage.clear();
                        // Only redirect if not in development mode
                        if (!window.location.hostname.includes('127.0.0.1') && !window.location.hostname.includes('localhost')) {
                            setTimeout(() => window.location.href = 'user-selection.html', 2000);
                        }
                    } else {
                        const errorMessage = errorData.detail || 
                                           (errorData.title && errorData.title[0]) ||
                                           (errorData.content && errorData.content[0]) ||
                                           'Failed to create post. Please try again.';
                        showNotification(errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error creating post:', error);
                showNotification(error.message || 'Network error. Please check your connection.', 'error');
            } finally {
                // Restore button state
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ========================
        // STUDY SESSIONS LOADING
        // ========================

        async function loadStudySessions() {
            // Prevent multiple simultaneous loads
            if (isLoading) {
                console.log('Already loading sessions, skipping...');
                return;
            }
            
            const sessionList = document.getElementById('sessionList');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            if (!sessionList) {
                console.log('Session list element not found');
                return;
            }

            isLoading = true;
            console.log('Loading study sessions...');

            try {
                // Show loading indicator
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'block';
                }
                
                // Try to fetch posts with and without authentication
                const headers = {};
                const accessToken = localStorage.getItem('access_token');
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                }

                const response = await fetch(`${window.StudySyncConfig.API_BASE_URL}/api/study-sessions/posts/`, {
                    method: 'GET',
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    const posts = data.results || data;
                    displayStudySessions(posts);
                } else if (response.status === 401) {
                    // Try without authentication for public posts
                    const publicResponse = await fetch(`${window.StudySyncConfig.API_BASE_URL}/api/study-sessions/posts/`);
                    if (publicResponse.ok) {
                        const data = await publicResponse.json();
                        const posts = data.results || data;
                        displayStudySessions(posts);
                    } else {
                        throw new Error('Unable to load study sessions');
                    }
                } else {
                    throw new Error('Failed to load study sessions');
                }
            } catch (error) {
                console.error('Error loading study sessions:', error);
                showError('Unable to load study sessions. Please refresh the page.');
            } finally {
                if (loadingIndicator) {
                    loadingIndicator.style.display = 'none';
                }
                isLoading = false;
                console.log('Finished loading study sessions');
            }
        }

        function displayStudySessions(posts) {
            const sessionList = document.getElementById('sessionList');
            if (!sessionList) return;
            
            if (!posts || posts.length === 0) {
                sessionList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìö</div>
                        <h3>No study sessions yet</h3>
                        <p>Be the first to create a study session and connect with fellow students!</p>
                        <button class="btn btn-primary" onclick="openPostModal()">Create First Post</button>
                        <div class="empty-benefits">
                            <p><strong>Benefits of creating study sessions:</strong></p>
                            <ul>
                                <li>ü§ù Find study partners with similar goals</li>
                                <li>üìñ Share knowledge and learn together</li>
                                <li>‚è∞ Set study schedules that work for everyone</li>
                                <li>üéØ Stay motivated and accountable</li>
                            </ul>
                        </div>
                    </div>
                `;
                return;
            }

            sessionList.innerHTML = posts.map(post => createSessionCard(post)).join('');
        }

        function createSessionCard(post) {
            const isLoggedIn = localStorage.getItem('access_token');
            const currentUserId = localStorage.getItem('user_data') ? 
                JSON.parse(localStorage.getItem('user_data')).id : null;
            const isOwnPost = currentUserId && post.user && post.user.id === currentUserId;
            
            const authorName = post.author_name || 
                             (post.user ? `${post.user.first_name || ''} ${post.user.last_name || ''}`.trim() : '') || 
                             (post.user ? post.user.username : 'Anonymous') || 'Anonymous';
            const authorInitials = getInitials(authorName);
            const authorAvatar = (post.user && post.user.profile_picture) || 
                `https://via.placeholder.com/50/3b82f6/ffffff?text=${encodeURIComponent(authorInitials)}`;
            
            const timeAgo = getTimeAgo(post.created_at);
            const postTypeLabel = getPostTypeLabel(post.post_type);
            const difficultyBadge = post.difficulty_level ? 
                `<span class="difficulty-badge ${post.difficulty_level}">${post.difficulty_level}</span>` : '';
            
            return `
                <div class="session-card-compact" data-post-id="${post.id}">
                    <div class="session-compact-header">
                        <div class="user-avatar-compact">
                            <img src="${authorAvatar}" alt="${authorName}" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                            <span class="avatar-fallback-compact" style="display: none;">${authorInitials}</span>
                        </div>
                        <div class="session-compact-content">
                            <div class="user-name-compact">${authorName}</div>
                            <div class="session-title-compact">${post.title}</div>
                            <div class="session-time-compact">${timeAgo}</div>
                        </div>
                        <div class="session-compact-actions">
                            ${isLoggedIn && !isOwnPost ? `
                                <button class="btn-compact btn-compact-primary" onclick="requestToJoin('${post.id}')">
                                    Request to join
                                </button>
                                <button class="btn-compact btn-compact-secondary" onclick="sendMessage('${post.user ? post.user.id : ''}')">
                                    Message
                                </button>
                            ` : isOwnPost ? `
                                <button class="btn-compact btn-compact-secondary" onclick="editPost('${post.id}')">
                                    Edit Post
                                </button>
                                <button class="btn-compact btn-compact-danger" onclick="deletePost('${post.id}')">
                                    Delete
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="session-compact-meta">
                        <span class="subject-tag">${post.subject_area}</span>
                        ${difficultyBadge}
                        <div class="session-compact-stats">
                            <span class="stat-compact">üôã ${post.pending_requests || 0} requests</span>
                            <span class="stat-compact">‚úÖ ${post.accepted_requests || 0} joined</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // ========================
        // INTERACTION FUNCTIONS
        // ========================

        async function requestToJoin(postId) {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showNotification('Please log in to request to join.', 'error');
                return;
            }

            try {
                const response = await fetch(`${window.StudySyncConfig.API_BASE_URL}/api/study-sessions/join-requests/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: JSON.stringify({
                        post: postId,
                        message: 'I would like to join this study session.'
                    })
                });

                if (response.ok) {
                    showNotification('Join request sent successfully! üéâ', 'success');
                    // Update button state
                    const card = document.querySelector(`[data-post-id="${postId}"]`);
                    if (card) {
                        const joinBtn = card.querySelector('.btn-primary');
                        if (joinBtn) {
                            joinBtn.textContent = 'Request Sent';
                            joinBtn.disabled = true;
                            joinBtn.classList.add('btn-disabled');
                        }
                    }
                } else {
                    const errorData = await response.json();
                    showNotification(errorData.detail || 'Failed to send join request', 'error');
                }
            } catch (error) {
                console.error('Error sending join request:', error);
                showNotification('Network error. Please try again.', 'error');
            }
        }

        function sendMessage(userId) {
            if (!userId) {
                showNotification('Cannot send message to this user.', 'error');
                return;
            }
            showNotification('Messaging feature coming soon! üí¨', 'info');
        }

        function editPost(postId) {
            showNotification('Edit functionality coming soon! ‚úèÔ∏è', 'info');
        }

        // ========================
        // UTILITY FUNCTIONS
        // ========================

        function getInitials(name) {
            if (!name) return 'U';
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2) || 'U';
        }

        function getTimeAgo(dateString) {
            if (!dateString) return 'Recently';
            
            const now = new Date();
            const postDate = new Date(dateString);
            const diffMs = now - postDate;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return new Date(dateString).toLocaleDateString();
        }

        function getPostTypeLabel(postType) {
            const labels = {
                'study_group': 'Study Group',
                'help_request': 'Help Request',
                'discussion': 'Discussion',
                'mentorship': 'Mentorship'
            };
            return labels[postType] || postType;
        }

        // ========================
        // POST DELETION FUNCTIONALITY
        // ========================

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this post? This action cannot be undone.')) {
                return;
            }

            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                showNotification('Please log in to delete posts.', 'error');
                return;
            }

            try {
                showNotification('Deleting post...', 'info');

                const response = await fetch(`${window.StudySyncConfig.API_BASE_URL}/api/study-sessions/posts/${postId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showNotification('Post deleted successfully! üóëÔ∏è', 'success');
                    // Remove the post from the DOM immediately
                    const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                    if (postElement) {
                        postElement.style.transition = 'opacity 0.3s ease-out';
                        postElement.style.opacity = '0';
                        setTimeout(() => {
                            postElement.remove();
                            // Check if no posts left and show empty state
                            const sessionList = document.getElementById('sessionList');
                            if (sessionList && sessionList.children.length === 0) {
                                loadStudySessions();
                            }
                        }, 300);
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Delete error:', errorData);
                    
                    if (response.status === 401) {
                        showNotification('Session expired. Please log in again.', 'error');
                        localStorage.clear();
                    } else if (response.status === 403) {
                        showNotification('You can only delete your own posts.', 'error');
                    } else if (response.status === 404) {
                        showNotification('Post not found or already deleted.', 'error');
                        // Reload to refresh the list
                        loadStudySessions();
                    } else {
                        const errorMessage = errorData.detail || 'Failed to delete post. Please try again.';
                        showNotification(errorMessage, 'error');
                    }
                }
            } catch (error) {
                console.error('Error deleting post:', error);
                showNotification('Network error. Please check your connection and try again.', 'error');
            }
        }

        // ========================
        // POST EDIT FUNCTIONALITY (Placeholder)
        // ========================

        function editPost(postId) {
            // TODO: Implement edit functionality
            showNotification('Edit functionality will be implemented soon!', 'info');
            console.log('Edit post:', postId);
        }

        // ========================
        // MESSAGING FUNCTIONALITY (Placeholder)
        // ========================

        function sendMessage(userId) {
            // TODO: Implement messaging functionality
            showNotification('Messaging functionality will be implemented soon!', 'info');
            console.log('Send message to user:', userId);
        }

        // ========================
        // JOIN REQUEST FUNCTIONALITY (Placeholder)
        // ========================

        function requestToJoin(postId) {
            // TODO: Implement join request functionality
            showNotification('Join request functionality will be implemented soon!', 'info');
            console.log('Request to join post:', postId);
        }

        // ========================
        // AUTHENTICATION FUNCTIONS
        // ========================

        function logout() {
            if (confirm('Are you sure you want to log out?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user_data');
                showNotification('Logged out successfully!', 'success');
                setTimeout(() => {
                    window.location.href = 'user-selection.html';
                }, 1000);
            }
        }

        function toggleDropdown() {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        function showNotification(message, type = 'info') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        function showError(message) {
            const sessionList = document.getElementById('sessionList');
            if (sessionList) {
                sessionList.innerHTML = `
                    <div class="error-message">
                        <div class="error-icon">‚ö†Ô∏è</div>
                        <h3>Oops! Something went wrong</h3>
                        <p>${message}</p>
                        <button class="btn btn-primary" onclick="retryLoadSessions()">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        // Debounced retry function
        let retryTimeout;
        function retryLoadSessions() {
            if (retryTimeout) {
                clearTimeout(retryTimeout);
            }
            retryTimeout = setTimeout(() => {
                if (!isLoading) {
                    loadStudySessions();
                }
            }, 500);
        }
    </script>
</body>
</html>