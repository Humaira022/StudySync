<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySync - Profile</title>
    <link rel="stylesheet" href="assets/css/main.css">
    <style>
        .profile-card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 2rem;
            max-width: 600px;
            margin: 2rem auto;
            text-align: center;
        }

        .profile-avatar-section {
            margin-bottom: 2rem;
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #e2e8f0;
            margin-bottom: 1rem;
        }

        .avatar-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .profile-info {
            text-align: left;
            margin: 2rem 0;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            font-weight: 500;
            color: #64748b;
        }

        .info-value {
            font-weight: 600;
            color: #1e293b;
        }

        .file-input {
            display: none;
        }

        .user-avatar-dropdown {
            position: relative;
            display: inline-block;
        }

        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #e2e8f0;
            transition: border-color 0.2s ease;
        }

        .user-avatar:hover {
            border-color: #3b82f6;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            z-index: 1000;
            margin-top: 0.5rem;
        }

        .dropdown-content a {
            color: #334155;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            font-size: 0.875rem;
            transition: background-color 0.2s ease;
        }

        .dropdown-content a:hover {
            background-color: #f8fafc;
        }

        .dropdown-content a:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .dropdown-content a:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .show {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #64748b;
        }

        .error {
            text-align: center;
            padding: 3rem;
            color: #dc2626;
        }

        .success-message {
            background: #dcfce7;
            color: #166534;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #bbf7d0;
            display: none;
        }

        .preview-container {
            display: none;
            margin-top: 1rem;
        }

        .preview-image {
            max-width: 120px;
            max-height: 120px;
            border-radius: 50%;
            border: 4px solid #3b82f6;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 500px;
            text-align: center;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 2rem;
        }

        .btn-danger {
            background-color: #dc2626 !important;
            color: white !important;
        }

        @media (max-width: 768px) {
            .profile-card {
                margin: 1rem;
                padding: 1.5rem;
            }
            
            .avatar-buttons {
                flex-direction: column;
                align-items: center;
            }
        }

        .edit-btn {
            font-size: 0.75rem !important;
            padding: 0.25rem 0.5rem !important;
            margin-left: 0.5rem;
        }

        .btn-sm {
            font-size: 0.8rem;
            padding: 0.25rem 0.75rem;
        }

        .success-message {
            background-color: #d4edda;
            color: #155724;
            padding: 0.75rem;
            border-radius: 0.25rem;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="index.html" class="logo">StudySync</a>
            <nav class="nav">
                <a href="my-posts.html" class="nav-link">My Posts</a>
                <a href="mentorship.html" class="nav-link">Mentorship</a>
                <a href="about.html" class="nav-link">About</a>
                <a href="contact.html" class="nav-link">Contact</a>
                <div class="user-avatar-dropdown">
                    <img id="navUserAvatar" src="https://via.placeholder.com/40/3b82f6/ffffff?text=U" alt="User Avatar" class="user-avatar" onclick="toggleDropdown()">
                    <div id="userDropdown" class="dropdown-content">
                        <a href="profile.html">üë§ Profile Settings</a>
                        <a href="#" onclick="logout()">üö™ Logout</a>
                    </div>
                </div>
            </nav>
        </div>
    </header>

    <main class="main">
        <div class="container">
            <div id="loading" class="loading">
                <h3>Loading your profile...</h3>
            </div>

            <div id="error" class="error" style="display: none;">
                <h3>Error loading profile</h3>
                <p>Please <a href="auth.html" style="color: #3b82f6;">login again</a> or contact support.</p>
            </div>

            <div id="profileContent">
                <div class="profile-card">
                    <div class="success-message" id="successMessage">
                        Profile updated successfully!
                    </div>

                    <!-- Profile Avatar Section -->
                    <div class="profile-avatar-section">
                        <img id="profileAvatar" src="" alt="Profile Picture" class="profile-avatar">
                        <div class="preview-container" id="previewContainer">
                            <p><strong>Preview:</strong></p>
                            <img id="previewImage" src="" alt="Preview" class="preview-image">
                        </div>
                        <div class="avatar-buttons">
                            <input type="file" id="profilePictureInput" class="file-input" accept="image/*">
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('profilePictureInput').click()">
                                üì∑ Edit Photo
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="removeProfilePicture()" style="background-color: #dc2626;">
                                üóëÔ∏è Remove Photo
                            </button>
                        </div>
                        <p style="color: #64748b; font-size: 0.75rem; margin-top: 0.5rem;">
                            JPG, PNG, GIF. Max size: 5MB
                        </p>
                    </div>

                    <!-- Profile Information -->
                    <div class="profile-info">
                        <div class="info-item">
                            <span class="info-label">Name</span>
                            <span class="info-value" id="userName">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Student ID</span>
                            <span class="info-value" id="studentId">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Institution</span>
                            <span class="info-value" id="institution">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Department</span>
                            <span class="info-value" id="department">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Year of Study</span>
                            <span class="info-value" id="yearOfStudy">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date of Birth</span>
                            <span class="info-value" id="dateOfBirth">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone Number</span>
                            <span class="info-value" id="phoneNumber">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Gender</span>
                            <span class="info-value" id="gender">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Skills</span>
                            <span class="info-value" id="skills">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Interests</span>
                            <span class="info-value" id="interests">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Location</span>
                            <span class="info-value" id="location">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Phone Verified</span>
                            <span class="info-value" id="phoneVerified">-</span>
                        </div>
                    </div>

                    <!-- Delete Account Button -->
                    <div style="margin-top: 2rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                        <button class="btn btn-secondary" onclick="showDeleteModal()" style="background-color: #dc2626; width: 100%;">
                            üóëÔ∏è Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let profilePictureFile = null;
        let profilePictureChanged = false;

        // Load user data when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
            setupProfilePictureUpload();
            
            // Also immediately show basic profile structure
            const userData = localStorage.getItem('user_data');
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    displayUserProfile(user);
                } catch (e) {
                    displayUserProfile({ first_name: 'User', last_name: '' });
                }
            } else {
                displayUserProfile({ first_name: 'User', last_name: '' });
            }
        });

        function setupProfilePictureUpload() {
            const fileInput = document.getElementById('profilePictureInput');
            fileInput.addEventListener('change', handleProfilePictureChange);
        }

        function handleProfilePictureChange(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file (JPG, PNG, GIF)');
                return;
            }

            profilePictureFile = file;
            profilePictureChanged = true;

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImage = document.getElementById('previewImage');
                const previewContainer = document.getElementById('previewContainer');
                
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Auto-save the profile picture
            saveProfilePicture();
        }

        function removeProfilePicture() {
            if (confirm('Are you sure you want to remove your profile picture?')) {
                profilePictureFile = null;
                profilePictureChanged = true;
                
                // Reset file input
                document.getElementById('profilePictureInput').value = '';
                
                // Hide preview
                document.getElementById('previewContainer').style.display = 'none';
                
                // Get user data for default avatar
                const userData = localStorage.getItem('user_data');
                let defaultAvatar = 'https://via.placeholder.com/120/e2e8f0/64748b?text=User';
                let navDefaultAvatar = 'https://via.placeholder.com/40/3b82f6/ffffff?text=U';
                
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        const initials = (user.first_name?.[0] || '') + (user.last_name?.[0] || '');
                        defaultAvatar = 'https://via.placeholder.com/120/e2e8f0/64748b?text=' + encodeURIComponent(initials);
                        navDefaultAvatar = 'https://via.placeholder.com/40/3b82f6/ffffff?text=' + encodeURIComponent(initials);
                    } catch (e) {
                        console.error('Error parsing user data:', e);
                    }
                }
                
                // Set avatars to default
                document.getElementById('profileAvatar').src = defaultAvatar;
                const navAvatar = document.getElementById('navUserAvatar');
                if (navAvatar) {
                    navAvatar.src = navDefaultAvatar;
                }
                
                // Auto-save the removal
                saveProfilePicture();
            }
        }

        async function saveProfilePicture() {
            const accessToken = localStorage.getItem('access_token');
            if (!accessToken) {
                alert('Please login again to save changes.');
                return;
            }

            try {
                const formData = new FormData();
                
                if (profilePictureFile) {
                    formData.append('profile_picture', profilePictureFile);
                } else {
                    formData.append('remove_profile_picture', 'true');
                }

                const response = await fetch('http://127.0.0.1:8000/api/auth/profile/picture/', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccessMessage('Profile picture updated successfully!');
                    
                    // Update avatars
                    if (result.profile_picture) {
                        document.getElementById('profileAvatar').src = result.profile_picture;
                        const navAvatar = document.getElementById('navUserAvatar');
                        if (navAvatar) {
                            navAvatar.src = result.profile_picture;
                        }
                    }
                    
                    // Reset flags
                    profilePictureChanged = false;
                    profilePictureFile = null;
                    document.getElementById('previewContainer').style.display = 'none';
                    
                } else {
                    alert('Failed to update profile picture: ' + (result.error || 'Unknown error'));
                }

            } catch (error) {
                console.error('Error saving profile picture:', error);
                alert('Error saving profile picture. Please check your internet connection.');
            }
        }

        async function loadUserProfile() {
            try {
                const userData = localStorage.getItem('user_data');
                const accessToken = localStorage.getItem('access_token');

                if (!userData || !accessToken) {
                    showError('No user data found. Please login again.');
                    return;
                }

                const user = JSON.parse(userData);
                
                // Try to fetch fresh data from backend with better error handling
                let profile = null;
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/auth/profile/manage/', {
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const freshData = await response.json();
                        profile = freshData.profile;
                        // Update user data if we got fresh data
                        if (freshData.user) {
                            Object.assign(user, freshData.user);
                        }
                    } else if (response.status === 401) {
                        console.warn('Access token expired, attempting to refresh...');
                        // Try to refresh the token
                        const refreshed = await refreshAccessToken();
                        if (refreshed) {
                            // Retry the API call with new token
                            return loadUserProfile();
                        }
                    } else {
                        console.warn('API error:', response.status, response.statusText);
                    }
                } catch (apiError) {
                    console.warn('Failed to fetch fresh data, using cached data:', apiError);
                }

                // Always display user profile, even if API fails
                displayUserProfile(user, profile);

            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Error loading profile data.');
            }
        }

        function displayUserProfile(user, profile = null) {
            // Hide loading, show content
            document.getElementById('loading').style.display = 'none';
            document.getElementById('profileContent').style.display = 'block';

            // Debug: Log the user and profile data
            console.log('User data:', user);
            console.log('Profile data:', profile);
            console.log('Additional localStorage data:', {
                signup_data: localStorage.getItem('signup_data'),
                user_data: localStorage.getItem('user_data')
            });

            // Use default values if user data is missing
            // Check for name from multiple sources including signup data
            const firstName = user?.first_name || '';
            const lastName = user?.last_name || '';
            const signupName = user?.name || user?.extracted_full_name || ''; // From signup process
            
            // Construct full name - prefer signup name if available, otherwise combine first+last
            let fullName = signupName;
            if (!fullName || fullName.trim() === '') {
                fullName = `${firstName} ${lastName}`.trim();
            }
            if (!fullName || fullName.trim() === '') {
                fullName = 'User'; // Final fallback
            }

            // Profile Avatar - use default if no profile picture
            const defaultAvatar = 'https://via.placeholder.com/120/e2e8f0/64748b?text=' + 
                encodeURIComponent((firstName[0] || '') + (lastName[0] || ''));
            const avatarSrc = profile?.profile_picture || user?.profile_picture || defaultAvatar;
            
            document.getElementById('profileAvatar').src = avatarSrc;
            
            // Update navbar avatar with smaller default
            const navDefaultAvatar = 'https://via.placeholder.com/40/3b82f6/ffffff?text=' + 
                encodeURIComponent((firstName[0] || '') + (lastName[0] || ''));
            const navAvatarSrc = profile?.profile_picture || user?.profile_picture || navDefaultAvatar;
            
            const navAvatar = document.getElementById('navUserAvatar');
            if (navAvatar) {
                navAvatar.src = navAvatarSrc;
            }

            // Profile Information - handle missing data gracefully
            document.getElementById('userName').textContent = fullName || 'Not provided';
            
            // Check both user and profile objects for the information
            // Also check localStorage for any additional signup data
            const signupData = localStorage.getItem('signup_data');
            const authData = localStorage.getItem('auth_form_data'); // Check for auth form data
            let additionalData = {};
            
            if (signupData) {
                try {
                    additionalData = JSON.parse(signupData);
                } catch (e) {
                    console.warn('Error parsing signup data:', e);
                }
            }
            
            if (authData) {
                try {
                    const authFormData = JSON.parse(authData);
                    Object.assign(additionalData, authFormData);
                } catch (e) {
                    console.warn('Error parsing auth data:', e);
                }
            }
            
            // Student ID - prioritize backend profile data, then fallback to localStorage
            const studentId = profile?.student_id || user?.student_id || user?.studentId || 
                             additionalData?.student_id || additionalData?.studentId ||
                             user?.extracted_full_name || additionalData?.extracted_full_name || 'Not provided';
            document.getElementById('studentId').textContent = studentId;
            
            // Institution - prioritize backend profile data (institution field), then fallback to signup data
            const institution = profile?.institution || profile?.university || user?.institution || user?.university || 
                               user?.organization_name || additionalData?.organization_name ||
                               additionalData?.institution || additionalData?.university || additionalData?.organizationName || 'Not provided';
            document.getElementById('institution').textContent = institution;
            
            // Department
            const department = profile?.department || user?.department || additionalData?.department || 'Not provided';
            document.getElementById('department').textContent = department;
            
            // Year of Study
            const yearOfStudy = profile?.year_of_study || user?.year_of_study || additionalData?.year_of_study || 'Not provided';
            document.getElementById('yearOfStudy').textContent = yearOfStudy;
            
            // Date of Birth - prioritize backend profile data, then fallback to signup data
            let dobText = 'Not provided';
            const dateOfBirth = profile?.date_of_birth || user?.date_of_birth || user?.dateOfBirth || 
                               user?.date_of_birth || additionalData?.date_of_birth || additionalData?.dateOfBirth;
            
            if (dateOfBirth) {
                try {
                    const date = new Date(dateOfBirth);
                    dobText = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } catch (e) {
                    dobText = dateOfBirth;
                }
            }
            document.getElementById('dateOfBirth').textContent = dobText;
            
            // Phone Number - prioritize user data from signup, then backend profile data
            const phoneNumber = user?.phone_number || user?.phoneNumber || user?.phone || 
                               profile?.phone_number || additionalData?.phone_number || 
                               additionalData?.phoneNumber || additionalData?.phone || 'Not provided';
            document.getElementById('phoneNumber').textContent = phoneNumber;
            
            // Gender
            const gender = profile?.gender || user?.gender || additionalData?.gender || 'Not provided';
            document.getElementById('gender').textContent = gender;
            
            // Skills (array field)
            let skillsText = 'Not provided';
            const skills = profile?.skills || user?.skills || additionalData?.skills;
            if (skills && Array.isArray(skills) && skills.length > 0) {
                skillsText = skills.join(', ');
            } else if (skills && typeof skills === 'string') {
                skillsText = skills;
            }
            document.getElementById('skills').textContent = skillsText;
            
            // Interests (array field)
            let interestsText = 'Not provided';
            const interests = profile?.interests || user?.interests || additionalData?.interests;
            if (interests && Array.isArray(interests) && interests.length > 0) {
                interestsText = interests.join(', ');
            } else if (interests && typeof interests === 'string') {
                interestsText = interests;
            }
            document.getElementById('interests').textContent = interestsText;
            
            // Location
            const location = profile?.location || user?.location || additionalData?.location || 'Not provided';
            document.getElementById('location').textContent = location;
            
            // Phone Verified
            const phoneVerified = profile?.phone_verified || user?.phone_verified || false;
            document.getElementById('phoneVerified').textContent = phoneVerified ? 'Yes' : 'No';
            
            // Add edit buttons for missing information
            addEditButtonsForMissingInfo({
                studentId, institution, department, yearOfStudy, dobText, phoneNumber,
                gender, skillsText, interestsText, location
            });
        }

        function addEditButtonsForMissingInfo(profileData) {
            // Add edit buttons for missing information
            const fieldsToCheck = [
                { field: 'studentId', value: profileData.studentId, label: 'Add Student ID' },
                { field: 'institution', value: profileData.institution, label: 'Add Institution' },
                { field: 'department', value: profileData.department, label: 'Add Department' },
                { field: 'yearOfStudy', value: profileData.yearOfStudy, label: 'Add Year of Study' },
                { field: 'dateOfBirth', value: profileData.dobText, label: 'Add Date of Birth' },
                { field: 'phoneNumber', value: profileData.phoneNumber, label: 'Add Phone Number' },
                { field: 'gender', value: profileData.gender, label: 'Add Gender' },
                { field: 'skills', value: profileData.skillsText, label: 'Add Skills' },
                { field: 'interests', value: profileData.interestsText, label: 'Add Interests' },
                { field: 'location', value: profileData.location, label: 'Add Location' }
            ];
            
            fieldsToCheck.forEach(({ field, value, label }) => {
                if (value === 'Not provided') {
                    addEditButton(field, label);
                }
            });
        }

        function addEditButton(fieldId, buttonText) {
            const field = document.getElementById(fieldId);
            if (field && !field.nextElementSibling?.classList.contains('edit-btn')) {
                const editBtn = document.createElement('button');
                editBtn.textContent = buttonText;
                editBtn.className = 'btn btn-sm btn-outline edit-btn';
                editBtn.style.marginLeft = '10px';
                editBtn.style.fontSize = '0.8rem';
                editBtn.onclick = () => editField(fieldId);
                field.parentNode.appendChild(editBtn);
            }
        }

        function editField(fieldId) {
            const field = document.getElementById(fieldId);
            const currentValue = field.textContent;
            
            let inputType = 'text';
            let placeholder = '';
            let isSelect = false;
            let options = [];
            
            switch(fieldId) {
                case 'studentId':
                    placeholder = 'Enter your Student ID';
                    break;
                case 'institution':
                    placeholder = 'Enter your Institution/University';
                    break;
                case 'department':
                    placeholder = 'Enter your Department';
                    break;
                case 'yearOfStudy':
                    inputType = 'number';
                    placeholder = 'Enter your Year of Study (1-4)';
                    break;
                case 'dateOfBirth':
                    inputType = 'date';
                    placeholder = 'Select your date of birth';
                    break;
                case 'phoneNumber':
                    inputType = 'tel';
                    placeholder = 'Enter your phone number';
                    break;
                case 'gender':
                    isSelect = true;
                    options = ['male', 'female', 'other'];
                    break;
                case 'skills':
                    placeholder = 'Enter your skills (comma-separated)';
                    break;
                case 'interests':
                    placeholder = 'Enter your interests (comma-separated)';
                    break;
                case 'location':
                    placeholder = 'Enter your location';
                    break;
            }
            
            let input;
            if (isSelect) {
                input = document.createElement('select');
                input.style.width = '200px';
                input.style.padding = '5px';
                input.style.marginRight = '10px';
                
                // Add default option
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = 'Select ' + fieldId;
                input.appendChild(defaultOption);
                
                // Add options
                options.forEach(option => {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option.charAt(0).toUpperCase() + option.slice(1);
                    if (currentValue.toLowerCase() === option) {
                        optionElement.selected = true;
                    }
                    input.appendChild(optionElement);
                });
            } else {
                input = document.createElement('input');
                input.type = inputType;
                input.value = currentValue === 'Not provided' ? '' : currentValue;
                input.placeholder = placeholder;
                input.style.width = '200px';
                input.style.padding = '5px';
                input.style.marginRight = '10px';
                
                if (fieldId === 'yearOfStudy') {
                    input.min = '1';
                    input.max = '10';
                }
            }
            
            const saveBtn = document.createElement('button');
            saveBtn.textContent = 'Save';
            saveBtn.className = 'btn btn-sm btn-primary';
            saveBtn.onclick = () => saveField(fieldId, input.value);
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn btn-sm btn-secondary';
            cancelBtn.style.marginLeft = '5px';
            cancelBtn.onclick = () => cancelEdit(fieldId);
            
            // Replace the text with input
            field.textContent = '';
            field.appendChild(input);
            field.appendChild(saveBtn);
            field.appendChild(cancelBtn);
            
            input.focus();
        }

        function saveField(fieldId, value) {
            if (!value.trim()) {
                alert('Please enter a value');
                return;
            }
            
            // Update the display
            const field = document.getElementById(fieldId);
            if (fieldId === 'dateOfBirth' && value) {
                try {
                    const date = new Date(value);
                    field.textContent = date.toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });
                } catch (e) {
                    field.textContent = value;
                }
            } else {
                field.textContent = value;
            }
            
            // TODO: Save to backend
            // For now, save to localStorage
            updateUserDataInStorage(fieldId, value);
            
            // Remove edit button since we now have data
            const editBtn = field.parentNode.querySelector('.edit-btn');
            if (editBtn) {
                editBtn.remove();
            }
            
            showSuccessMessage(`${fieldId} updated successfully!`);
        }

        function cancelEdit(fieldId) {
            // Restore original text
            loadUserProfile(); // Reload to restore original state
        }

        function updateUserDataInStorage(fieldId, value) {
            try {
                const userData = localStorage.getItem('user_data');
                if (userData) {
                    const user = JSON.parse(userData);
                    
                    // Map field IDs to storage keys
                    const fieldMap = {
                        'studentId': 'student_id',
                        'institution': 'institution',
                        'department': 'department',
                        'yearOfStudy': 'year_of_study',
                        'dateOfBirth': 'date_of_birth',
                        'phoneNumber': 'phone_number',
                        'gender': 'gender',
                        'skills': 'skills',
                        'interests': 'interests',
                        'location': 'location'
                    };
                    
                    let processedValue = value;
                    
                    // Process array fields (skills, interests)
                    if (fieldId === 'skills' || fieldId === 'interests') {
                        processedValue = value.split(',').map(item => item.trim()).filter(item => item.length > 0);
                    }
                    
                    // Process numeric fields
                    if (fieldId === 'yearOfStudy') {
                        processedValue = parseInt(value);
                    }
                    
                    user[fieldMap[fieldId]] = processedValue;
                    localStorage.setItem('user_data', JSON.stringify(user));
                    
                    // Also try to save to backend
                    saveProfileToBackend(fieldMap[fieldId], processedValue);
                }
            } catch (e) {
                console.error('Error updating user data in storage:', e);
            }
        }

        async function saveProfileToBackend(fieldName, value) {
            try {
                const accessToken = localStorage.getItem('access_token');
                if (!accessToken) {
                    console.warn('No access token available for backend save');
                    return;
                }

                const response = await fetch('http://127.0.0.1:8000/api/auth/profile/manage/', {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        [fieldName]: value
                    })
                });

                if (response.ok) {
                    console.log(`‚úÖ ${fieldName} saved to backend successfully`);
                } else {
                    console.warn(`‚ö†Ô∏è Failed to save ${fieldName} to backend:`, response.status);
                }
            } catch (error) {
                console.error('Error saving to backend:', error);
            }
        }

        function confirmDeleteAccount() {
            const confirmation = document.getElementById('deleteConfirmation').value;
            
            if (confirmation === 'DELETE_MY_ACCOUNT') {
                hideDeleteModal();
                deleteAccount();
            } else {
                alert('Account deletion cancelled. You must type "DELETE_MY_ACCOUNT" exactly.');
            }
        }

        // Function to refresh the access token
        async function refreshAccessToken() {
            const refreshToken = localStorage.getItem('refresh_token');
            
            if (!refreshToken) {
                console.log('No refresh token available');
                return null;
            }

            try {
                console.log('Attempting to refresh access token...');
                const response = await fetch('http://127.0.0.1:8000/api/auth/token/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        refresh: refreshToken
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const newAccessToken = data.access;
                    
                    // Update localStorage with new access token
                    localStorage.setItem('access_token', newAccessToken);
                    console.log('Access token refreshed successfully');
                    return newAccessToken;
                } else {
                    console.log('Failed to refresh token, response:', response.status);
                    return null;
                }
            } catch (error) {
                console.error('Error refreshing token:', error);
                return null;
            }
        }

        async function deleteAccount() {
            let accessToken = localStorage.getItem('access_token');
            
            console.log('Access token exists:', !!accessToken);
            console.log('Access token length:', accessToken ? accessToken.length : 0);
            
            if (!accessToken) {
                alert('Please login again to delete your account.');
                return;
            }

            try {
                // Show loading state
                const deleteBtn = document.querySelector('button[onclick="confirmDeleteAccount()"]');
                const originalText = deleteBtn.textContent;
                deleteBtn.textContent = 'Deleting Account...';
                deleteBtn.disabled = true;

                console.log('Attempting to delete account...');

                const makeDeleteRequest = async (token) => {
                    return await fetch('http://127.0.0.1:8000/api/auth/account/delete/', {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            confirmation: 'DELETE_MY_ACCOUNT'
                        })
                    });
                };

                let response = await makeDeleteRequest(accessToken);

                // If token is invalid, try to refresh it
                if (response.status === 401) {
                    console.log('Access token expired, attempting to refresh...');
                    const newAccessToken = await refreshAccessToken();
                    
                    if (newAccessToken) {
                        console.log('Retrying delete request with new token...');
                        response = await makeDeleteRequest(newAccessToken);
                        accessToken = newAccessToken;
                    } else {
                        // Reset button state
                        deleteBtn.textContent = originalText;
                        deleteBtn.disabled = false;
                        
                        alert('Your session has expired. Please login again to delete your account.');
                        // Redirect to login
                        window.location.href = 'user-selection.html';
                        return;
                    }
                }

                console.log('Response status:', response.status);
                console.log('Response status text:', response.statusText);
                console.log('Response ok:', response.ok);

                let result;
                const contentType = response.headers.get('content-type');
                console.log('Response content type:', contentType);

                if (contentType && contentType.includes('application/json')) {
                    try {
                        result = await response.json();
                        console.log('Response data:', result);
                    } catch (jsonError) {
                        console.error('Error parsing JSON response:', jsonError);
                        const text = await response.text();
                        console.log('Response text:', text);
                        throw new Error('Server returned invalid JSON response: ' + text);
                    }
                } else {
                    const text = await response.text();
                    console.log('Response text (non-JSON):', text);
                    throw new Error('Server returned non-JSON response: ' + text);
                }

                if (response.ok) {
                    alert('Account deleted successfully. All your data has been removed from our system. You will be redirected to the login page.');
                    
                    // Clear all local storage data
                    localStorage.clear();
                    
                    // Redirect to login page
                    window.location.href = 'user-selection.html';
                } else {
                    // Reset button state
                    deleteBtn.textContent = originalText;
                    deleteBtn.disabled = false;
                    
                    const errorMessage = result.error || result.message || result.detail || result.details || `HTTP ${response.status}: ${response.statusText}`;
                    console.error('API Error:', errorMessage);
                    alert('Error deleting account: ' + errorMessage);
                }
            } catch (error) {
                console.error('Delete account error:', error);
                
                // Reset button state
                const deleteBtn = document.querySelector('button[onclick="confirmDeleteAccount()"]');
                if (deleteBtn) {
                    deleteBtn.textContent = 'Delete Account';
                    deleteBtn.disabled = false;
                }
                
                alert('Error deleting account: ' + error.message + '\nPlease check the browser console for more details.');
            }
        }

        function toggleDropdown() {
            document.getElementById("userDropdown").classList.toggle("show");
        }

        // Close dropdown when clicking outside
        window.onclick = function(event) {
            if (!event.target.matches('.user-avatar')) {
                var dropdowns = document.getElementsByClassName("dropdown-content");
                for (var i = 0; i < dropdowns.length; i++) {
                    var openDropdown = dropdowns[i];
                    if (openDropdown.classList.contains('show')) {
                        openDropdown.classList.remove('show');
                    }
                }
            }
        }

        function showSuccessMessage(message) {
            const successEl = document.getElementById('successMessage');
            successEl.textContent = message;
            successEl.style.display = 'block';
            
            // Hide after 3 seconds
            setTimeout(() => {
                successEl.style.display = 'none';
            }, 3000);
        }

        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.querySelector('#error p').textContent = message;
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user_data');
            window.location.href = 'auth.html';
        }

        // Modal functions for delete account
        function showDeleteModal() {
            document.getElementById('deleteModal').style.display = 'block';
            document.getElementById('deleteConfirmation').value = '';
            
            // Add real-time validation
            const confirmationInput = document.getElementById('deleteConfirmation');
            const deleteBtn = document.querySelector('button[onclick="confirmDeleteAccount()"]');
            
            confirmationInput.addEventListener('input', function() {
                if (this.value === 'DELETE_MY_ACCOUNT') {
                    deleteBtn.disabled = false;
                    deleteBtn.style.backgroundColor = '#dc2626';
                    deleteBtn.style.opacity = '1';
                } else {
                    deleteBtn.disabled = true;
                    deleteBtn.style.backgroundColor = '#9ca3af';
                    deleteBtn.style.opacity = '0.6';
                }
            });
            
            // Initially disable the delete button
            deleteBtn.disabled = true;
            deleteBtn.style.backgroundColor = '#9ca3af';
            deleteBtn.style.opacity = '0.6';
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            document.getElementById('deleteConfirmation').value = '';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('deleteModal');
            if (event.target == modal) {
                hideDeleteModal();
            }
        }
    </script>

    <!-- Delete Account Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content">
            <h3>‚ö†Ô∏è Delete Account</h3>
            <p><strong>WARNING:</strong> This action will permanently delete your account and all associated data. This cannot be undone.</p>
            
            <div class="form-group" style="margin: 20px 0;">
                <label for="deleteConfirmation">To confirm, please type: <strong>DELETE_MY_ACCOUNT</strong></label>
                <input type="text" id="deleteConfirmation" placeholder="Type DELETE_MY_ACCOUNT to confirm" 
                       style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="hideDeleteModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
            </div>
        </div>
    </div>
</body>
</html>
</body>
</html>
