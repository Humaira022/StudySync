<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudySync - Simple Signup</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="stylesheet" href="assets/css/auth.css">
    <style>
        .step { display: none; }
        .step.active { display: block; }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: border-color 0.3s;
        }
        .upload-area:hover {
            border-color: #007bff;
        }
        .upload-area.dragover {
            border-color: #28a745;
            background: #f8fff9;
        }
        .file-preview {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-container">
            <!-- Step 1: Google Signup -->
            <div id="step1" class="step active">
                <div class="auth-card">
                    <h2 id="title">Join StudySync</h2>
                    <p id="subtitle">Sign up to get started</p>
                    
                    <div id="g_id_onload"
                         data-client_id="1061988044539-0vq3h3fk08tjs9ncg63oetudgvt0onu8.apps.googleusercontent.com"
                         data-context="signup"
                         data-ux_mode="popup"
                         data-callback="handleGoogleSignIn"
                         data-auto_prompt="false">
                    </div>
                    
                    <div class="g_id_signin"
                         data-type="standard"
                         data-shape="rectangular"
                         data-theme="outline"
                         data-text="signup_with"
                         data-size="large"
                         data-logo_alignment="left">
                    </div>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; font-size: 14px;">
                        <p><strong>What happens next:</strong></p>
                        <ul style="text-align: left; margin: 10px 0;">
                            <li><strong>Students:</strong> Upload Student ID card</li>
                            <li><strong>Mentors:</strong> Upload National ID + Organization ID</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Step 2: Document Upload -->
            <div id="step2" class="step">
                <div class="auth-card">
                    <h2>Document Verification</h2>
                    <p>Welcome <span id="userName"></span>! Please upload your ID documents.</p>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <p>Step 2 of 3: Document Upload</p>
                    
                    <!-- Student ID Upload -->
                    <div id="studentUpload" style="display: none;">
                        <h3>üìö Student ID Card</h3>
                        <div class="upload-area" onclick="document.getElementById('studentIdFile').click()">
                            <p>üìÅ Click to upload your Student ID card</p>
                            <p style="font-size: 12px; color: #666;">Supported: JPEG, PNG (Max 5MB)</p>
                        </div>
                        <input type="file" id="studentIdFile" accept="image/*" style="display: none;">
                        <div id="studentPreview" class="file-preview" style="display: none;"></div>
                    </div>

                    <!-- Mentor ID Upload -->
                    <div id="mentorUpload" style="display: none;">
                        <h3>üÜî National ID</h3>
                        <div class="upload-area" onclick="document.getElementById('nidFile').click()">
                            <p>üìÅ Click to upload your National ID</p>
                        </div>
                        <input type="file" id="nidFile" accept="image/*" style="display: none;">
                        <div id="nidPreview" class="file-preview" style="display: none;"></div>

                        <h3>üè¢ Organization/Company ID</h3>
                        <div class="upload-area" onclick="document.getElementById('companyIdFile').click()">
                            <p>üìÅ Click to upload your Organization ID</p>
                        </div>
                        <input type="file" id="companyIdFile" accept="image/*" style="display: none;">
                        <div id="companyPreview" class="file-preview" style="display: none;"></div>
                    </div>

                    <button id="processBtn" class="btn btn-primary" style="display: none;" onclick="processDocuments()">
                        üîç Process Documents & Create Account
                    </button>
                </div>
            </div>

            <!-- Step 3: Processing & Success -->
            <div id="step3" class="step">
                <div class="auth-card">
                    <h2>Processing...</h2>
                    <div id="processingStatus">
                        <p>üîç Processing your documents with OCR...</p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 100%; animation: pulse 2s infinite;"></div>
                        </div>
                    </div>
                    <div id="successMessage" style="display: none;">
                        <h2>üéâ Account Created Successfully!</h2>
                        <p>Welcome to StudySync! Redirecting to your dashboard...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/ocr.js"></script>
    <script>
        let userData = {};
        let userType = new URLSearchParams(window.location.search).get('type') || 'student';
        
        // Update title based on user type
        document.getElementById('title').textContent = userType === 'student' ? 'Join as Student' : 'Join as Mentor';

        function handleGoogleSignIn(response) {
            try {
                console.log('‚úÖ Google authentication successful');
                
                // Decode JWT token
                const payload = JSON.parse(atob(response.credential.split('.')[1]));
                
                // Store user data
                userData = {
                    email: payload.email,
                    name: payload.name,
                    googleId: payload.sub,
                    picture: payload.picture,
                    credential: response.credential,
                    userType: userType,
                    firstName: payload.name.split(' ')[0],
                    lastName: payload.name.split(' ').slice(1).join(' ')
                };
                
                console.log('üìß Email saved:', userData.email);
                console.log('üë§ User data:', userData);
                
                // Move to document upload
                showStep2();
                
            } catch (error) {
                console.error('‚ùå Google auth failed:', error);
                alert('Authentication failed: ' + error.message);
            }
        }

        function showStep2() {
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            document.getElementById('userName').textContent = userData.name;
            document.getElementById('progressFill').style.width = '66%';
            
            // Show appropriate upload section
            if (userType === 'student') {
                document.getElementById('studentUpload').style.display = 'block';
                setupFileUpload('studentIdFile', 'studentPreview');
            } else {
                document.getElementById('mentorUpload').style.display = 'block';
                setupFileUpload('nidFile', 'nidPreview');
                setupFileUpload('companyIdFile', 'companyPreview');
            }
        }

        function setupFileUpload(inputId, previewId) {
            const input = document.getElementById(inputId);
            const preview = document.getElementById(previewId);
            
            input.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    console.log(`üìÅ File uploaded: ${file.name}`);
                    preview.innerHTML = `‚úÖ ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`;
                    preview.style.display = 'block';
                    
                    // Store file
                    userData[inputId.replace('File', '')] = file;
                    
                    checkUploadComplete();
                }
            });
        }

        function checkUploadComplete() {
            let isComplete = false;
            
            if (userType === 'student') {
                isComplete = userData.studentId;
            } else {
                isComplete = userData.nid && userData.companyId;
            }
            
            if (isComplete) {
                document.getElementById('processBtn').style.display = 'block';
            }
        }

        async function processDocuments() {
            console.log('üîç Starting document processing...');
            
            // Move to processing step
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step3').classList.add('active');
            
            try {
                // Simulate OCR processing
                console.log('üìÑ Processing documents with OCR...');
                
                let ocrData = {};
                const ocrProcessor = new OCRProcessor();
                
                if (userType === 'student' && userData.studentId) {
                    ocrData.studentId = await ocrProcessor.processDocument(userData.studentId, 'studentId');
                }
                
                if (userType === 'mentor') {
                    if (userData.nid) {
                        ocrData.nid = await ocrProcessor.processDocument(userData.nid, 'nid');
                    }
                    if (userData.companyId) {
                        ocrData.companyId = await ocrProcessor.processDocument(userData.companyId, 'companyId');
                    }
                }
                
                console.log('üìã OCR results:', ocrData);
                
                // Create account
                await createAccount(ocrData);
                
            } catch (error) {
                console.error('‚ùå Processing failed:', error);
                alert('Processing failed: ' + error.message);
            }
        }

        async function createAccount(ocrData) {
            console.log('üöÄ Creating account...');
            
            const accountData = {
                credential: userData.credential,
                email: userData.email,
                name: userData.name,
                google_id: userData.googleId,
                profile_picture: userData.picture,
                user_type: userData.userType,
                first_name: userData.firstName,
                last_name: userData.lastName,
                ocr_data: ocrData
            };
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/auth/google/oauth/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(accountData)
                });
                
                const result = await response.json();
                console.log('üì• Account creation result:', result);
                
                if (response.ok) {
                    // Store tokens
                    localStorage.setItem('access_token', result.access_token);
                    localStorage.setItem('user_data', JSON.stringify(result.user));
                    
                    // Show success
                    document.getElementById('processingStatus').style.display = 'none';
                    document.getElementById('successMessage').style.display = 'block';
                    
                    // Redirect after delay
                    setTimeout(() => {
                        window.location.href = userType === 'student' ? '/student-dashboard.html' : '/mentor-dashboard.html';
                    }, 3000);
                } else {
                    throw new Error(result.error || 'Account creation failed');
                }
                
            } catch (error) {
                console.error('‚ùå Account creation failed:', error);
                alert('Account creation failed: ' + error.message);
            }
        }
    </script>
</body>
</html>
